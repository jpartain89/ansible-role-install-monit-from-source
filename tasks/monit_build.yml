---
# monit/tasks/build_monit.yml

- name: Bootstrapping
  shell: './bootstrap'
  args:
    chdir: "{{ monit_git_repo_dest }}"
  register: monit_bootstrap

- debug: var=monit_bootstrap
  when: monit_bootstrap|failed

- name: Configure --enable-optimized
  shell: './configure {{ monit_configure_options }}'
  args:
    chdir: "{{ monit_git_repo_dest }}"
  register: monit_configure

- debug: var=monit_configure
  when: monit_configure|failed

- name: Make
  shell: 'make'
  args:
    chdir: "{{ monit_git_repo_dest }}"
  register: monit_make

- debug: var=monit_make
  when: monit_make|failed

- name: sudo make install
  shell: 'make install'
  args:
    chdir: "{{ monit_git_repo_dest }}"
  register: monit_make_install
  become: true

- debug: var=monit_make_install
  when: monit_make_install|failed

- name: Debian | Create Autostart Script
  template:
    src: monit.service.j2
    dest: /lib/systemd/system/monit.service
    owner: root
    group: root
    mode: 0644
  when: ansible_os_family == "Debian"
  become: true
  register: monit_autostart_debian

- name: Debian | Add Monit to Autostart
  service:
    name: monit.service
    state: enabled
  become: true
  when: monit_autostart_debian|changed

- name: macOS | Create Autostart Script
  template:
    src: com.tildeslash.monit.plist.j2
    dest: /Library/LaunchDaemons/com.tildeslash.monit.plist
    owner: root
    group: wheel
    mode: 0644
  when: ansible_os_family == "Darwin"
  become: true
  register: monit_autostart_darwin

- name: Run make cleanall
  shell: 'make cleanall'
  args:
    chdir: "{{ monit_git_repo_dest }}"
  register: monit_make_cleanall
  become: true

- debug: var=monit_make_cleanall
  when: monit_make_cleanall|failed
